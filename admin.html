<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KDKS Secure Document Redaction</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { 
    font-family: 'Segoe UI', sans-serif; 
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
    color: #f1f5f9; 
    margin: 0; 
    min-height: 100vh;
  }
  
  .container { 
    padding: 30px; 
    max-width: 1000px; 
    margin: auto; 
  }
  
  .app-header {
    text-align: center;
    margin-bottom: 30px;
    position: relative;
    padding-bottom: 20px;
  }
  
  .app-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 25%;
    width: 50%;
    height: 2px;
    background: linear-gradient(90deg, transparent, #4a6cf7, transparent);
  }
  
  .app-header h1 {
    font-size: 2.5rem;
    margin: 0;
    background: linear-gradient(90deg, #4a6cf7, #10b981);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    font-weight: 800;
    letter-spacing: 1px;
  }
  
  .app-header p {
    color: #94a3b8;
    font-size: 1.1rem;
    margin-top: 10px;
  }
  
  .upload-area { 
    border: 2px dashed #334155; 
    border-radius: 16px; 
    padding: 50px 40px; 
    text-align: center; 
    cursor: pointer; 
    margin-bottom: 30px;
    transition: all 0.3s ease;
    background: rgba(15, 23, 42, 0.5);
    position: relative;
    overflow: hidden;
  }
  
  .upload-area::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, transparent, transparent, rgba(74, 108, 247, 0.2), transparent);
    z-index: -1;
    border-radius: 16px;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .upload-area:hover::before {
    opacity: 1;
  }
  
  .upload-area.active { 
    border-color: #4a6cf7; 
    background: rgba(74,108,247,0.1); 
    box-shadow: 0 5px 15px rgba(74, 108, 247, 0.1);
    transform: translateY(-2px);
  }
  
  .upload-area i {
    font-size: 56px;
    color: #4a6cf7;
    margin-bottom: 15px;
    transition: all 0.3s ease;
  }
  
  .upload-area.active i {
    transform: scale(1.1);
  }
  
  .upload-area p {
    font-size: 1.2rem;
    margin: 0;
    color: #cbd5e1;
  }
  
  .upload-area .subtext {
    font-size: 0.9rem;
    color: #94a3b8;
    margin-top: 10px;
  }
  
  canvas { 
    display: block; 
    margin: auto; 
    border: 1px solid #334155; 
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    background: #1e293b;
  }
  
  .controls { 
    display: flex; 
    gap: 15px; 
    margin: 30px 0; 
    justify-content: center;
  }
  
  button { 
    padding: 12px 24px; 
    border: none; 
    border-radius: 10px; 
    cursor: pointer; 
    font-weight: 600; 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    transition: all 0.2s ease;
    font-size: 1rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
  }
  
  button:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  
  .btn-success { 
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white; 
  }
  
  .btn-success:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
  }
  
  .btn-logout { 
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white; 
  }
  
  .btn-logout:hover {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
  }
  
  .canvas-container {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    margin: 20px 0;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  }
  
  .processing { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(15,23,42,0.95); 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    border-radius: 12px; 
    z-index: 20; 
    opacity: 0; 
    pointer-events: none; 
    transition: 0.3s; 
  }
  
  .processing.active { 
    opacity: 1; 
    pointer-events: all; 
  }
  
  .spinner { 
    width: 60px; 
    height: 60px; 
    border: 5px solid rgba(74,108,247,0.2); 
    border-top-color: #4a6cf7; 
    border-radius: 50%; 
    animation: spin 1s linear infinite; 
    margin-bottom: 20px; 
  }
  
  .processing span {
    font-size: 1.2rem;
    font-weight: 500;
    letter-spacing: 1px;
  }
  
  @keyframes spin { 
    to { 
      transform: rotate(360deg); 
    } 
  }
  
  .toast { 
    position: fixed; 
    top: 25px; 
    right: 25px; 
    background: #1e293b; 
    color: #f1f5f9; 
    padding: 18px 26px; 
    border-radius: 14px; 
    box-shadow: 0 12px 30px rgba(0,0,0,0.4); 
    display: flex; 
    align-items: center; 
    gap: 14px; 
    opacity: 0; 
    transform: translateX(100%); 
    transition: 0.4s; 
    z-index: 1000; 
    border-left: 4px solid #4a6cf7;
    max-width: 350px;
  }
  
  .toast.success {
    border-left-color: #10b981;
  }
  
  .toast.error {
    border-left-color: #ef4444;
  }
  
  .toast.show { 
    opacity: 1; 
    transform: translateX(0); 
  }
  
  .toast i {
    font-size: 1.5rem;
  }
  
  .toast.success i {
    color: #10b981;
  }
  
  .toast.error i {
    color: #ef4444;
  }
  
  .status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 20px 0;
    padding: 12px 20px;
    background: rgba(30, 41, 59, 0.5);
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.05);
  }
  
  .status-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.9rem;
    color: #94a3b8;
  }
  
  .status-item i {
    color: #4a6cf7;
  }
  
  .preview-header {
    text-align: center;
    margin: 25px 0 15px;
    font-size: 1.3rem;
    font-weight: 600;
    color: #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
  }
  
  .preview-header i {
    color: #4a6cf7;
  }
  
  @media (max-width: 768px) {
    .container {
      padding: 20px;
    }
    
    .app-header h1 {
      font-size: 2rem;
    }
    
    .upload-area {
      padding: 30px 20px;
    }
    
    .controls {
      flex-direction: column;
    }
    
    button {
      justify-content: center;
    }
    
    .status-bar {
      flex-direction: column;
      gap: 15px;
      align-items: flex-start;
    }
  }
</style>
</head>
<body>
<div class="container">
  <div class="app-header">
    <h1>KDKS Secure Document Redaction</h1>
    <p>Advanced AI-powered redaction for sensitive information</p>
  </div>
  
  <div class="upload-area" id="uploadArea">
    <i class="fa-solid fa-cloud-arrow-up"></i>
    <p>Drag & drop your document here or click to browse</p>
    <p class="subtext">Supports PDF, PNG, JPG, and JPEG files</p>
    <input type="file" id="fileInput" hidden accept=".pdf,.png,.jpg,.jpeg">
  </div>

  <div class="status-bar">
    <div class="status-item">
      <i class="fa-solid fa-face-meh-blank"></i>
      <span>Face Detection: Ready</span>
    </div>
    <div class="status-item">
      <i class="fa-solid fa-font"></i>
      <span>OCR Engine: Ready</span>
    </div>
    <div class="status-item">
      <i class="fa-solid fa-shield-halved"></i>
      <span>Security: Enabled</span>
    </div>
  </div>

  <div class="controls">
    <button class="btn btn-success" id="saveBtn"><i class="fa-solid fa-floppy-disk"></i> Save for User</button>
    <button class="btn btn-logout" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
  </div>

  <div class="preview-header">
    <i class="fa-solid fa-image"></i>
    <span>Processed Document Preview</span>
  </div>
  
  <div class="canvas-container">
    <canvas id="canvas"></canvas>
    <div class="processing" id="processingIndicator">
      <div class="spinner"></div>
      <span>Processing Document...</span>
    </div>
  </div>
</div>

<div class="toast" id="toast"><i class="fa-solid fa-circle-info"></i> <span id="toastMessage"></span></div>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@v2.1.5/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.min.js"></script>

<script>
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const saveBtn = document.getElementById('saveBtn');
const logoutBtn = document.getElementById('logoutBtn');
const processingIndicator = document.getElementById('processingIndicator');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let uploadedImage = null;
let currentFileName = "processed_file.png";

function showToast(msg, type='success'){
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toastMessage');
  toastMessage.innerText = msg;
  toast.className='toast show '+type;
  setTimeout(()=>toast.className='toast',4000);
}

// File upload
uploadArea.addEventListener('click', ()=>fileInput.click());
uploadArea.addEventListener('dragover', e=>{e.preventDefault(); uploadArea.classList.add('active');});
uploadArea.addEventListener('dragleave', e=>{e.preventDefault(); uploadArea.classList.remove('active');});

fileInput.addEventListener('change', async e=>{
  const file = e.target.files[0];
  if(!file) return;
  processingIndicator.classList.add('active'); // Show processing
  try{
    let offscreenCanvas = document.createElement('canvas');
    let offCtx = offscreenCanvas.getContext('2d');

    if(file.type==='application/pdf'){
      const buffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument(buffer).promise;
      const page = await pdf.getPage(1);
      const viewport = page.getViewport({scale:2});
      offscreenCanvas.width = viewport.width;
      offscreenCanvas.height = viewport.height;
      await page.render({canvasContext: offCtx, viewport}).promise;
      uploadedImage = new Image();
      uploadedImage.src = offscreenCanvas.toDataURL();
      await new Promise(r => uploadedImage.onload = r);
      currentFileName = file.name.replace(/\.[^/.]+$/,"")+"_redacted.png";
    } else if(file.type.startsWith('image/')){
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.src = url;
      await new Promise(r => img.onload = r);
      uploadedImage = img;
      offscreenCanvas.width = img.naturalWidth;
      offscreenCanvas.height = img.naturalHeight;
      offCtx.drawImage(img,0,0);
      currentFileName = file.name.replace(/\.[^/.]+$/,"")+"_redacted.png";
    } else {
      throw new Error("Unsupported file type");
    }

    showToast('Document uploaded successfully');

    // Process the document off-screen automatically
    await processDocument(offscreenCanvas);

  } catch(err){
    console.error(err);
    showToast('Error loading document','error');
  } finally{
    processingIndicator.classList.remove('active'); // Hide processing
  }
});

// Load face models
async function loadFaceModels(){
  const MODEL_URL="https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights";
  await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
}

// Process document off-screen
async function processDocument(offCanvas){
  if(!uploadedImage){ showToast('No document to process','error'); return; }
  processingIndicator.classList.add('active');

  try{
    await loadFaceModels();
    const offCtx = offCanvas.getContext('2d');

    // Blur faces
    const detections = await faceapi.detectAllFaces(offCanvas, new faceapi.TinyFaceDetectorOptions());
    detections.forEach(det=>{
      const {x,y,width,height} = det.box;
      const tmp = document.createElement('canvas');
      tmp.width = width; tmp.height = height;
      tmp.getContext('2d').drawImage(offCanvas,x,y,width,height,0,0,width,height);
      offCtx.save();
      offCtx.filter="blur(15px)";
      offCtx.drawImage(tmp,x,y);
      offCtx.restore();
    });

    // OCR and redact
    const {data} = await Tesseract.recognize(uploadedImage,'eng');
    const fakeData={"name":"John Doe","dob":"01/01/1990","dateofbirth":"01/01/1990","father":"Richard Roe","mother":"Jane Roe","address":"123 Sample Street","phone":"9876543210","email":"example@email.com","ssn":"999-88-7777","gender":"Female","ethnicity":"Indian","provider":"Cigna"};
    const keywords=["name","dob","gender","ethnicity","address","phone","email","ssn","provider","dateofbirth","father","mother"];

    data.lines.forEach(line=>{
      line.words.forEach((w,idx)=>{
        const txt=w.text.trim().toLowerCase().replace(':','');
        if(keywords.includes(txt)){
          let redactWords=[];
          for(let j=idx+1;j<line.words.length;j++){
            const nextWord=line.words[j].text.trim().toLowerCase().replace(':','');
            if(keywords.includes(nextWord)) break;
            redactWords.push(line.words[j]);
          }
          if(redactWords.length>0){
            const first=redactWords[0].bbox;
            const last=redactWords[redactWords.length-1].bbox;
            const box={x0:first.x0,y0:first.y0,x1:last.x1,y1:last.y1};
            offCtx.fillStyle="#ffffff";
            offCtx.fillRect(box.x0-1,box.y0-1,box.x1-box.x0+2,box.y1-box.y0+2);
            offCtx.fillStyle="#000000";
            offCtx.font=(box.y1-box.y0-2)+"px Arial";
            offCtx.fillText(fakeData[txt]||"REDACTED", box.x0, box.y1-2);
          }
        } else {
          const b=w.bbox, t=w.text.trim();
          if(/^\d{3}-?\d{2}-?\d{4}$/.test(t)){
            offCtx.fillStyle="#fff"; offCtx.fillRect(b.x0-1,b.y0-1,b.x1-b.x0+2,b.y1-b.y0+2);
            offCtx.fillStyle="#000"; offCtx.font=(b.y1-b.y0-2)+"px Arial"; offCtx.fillText(fakeData.ssn,b.x0,b.y1-2);
          }
          if(/^\(?\d{3}\)?\s?-?\d{3}\s?-?\d{4}$/.test(t)){
            offCtx.fillStyle="#fff"; offCtx.fillRect(b.x0-1,b.y0-1,b.x1-b.x0+2,b.y1-b.y0+2);
            offCtx.fillStyle="#000"; offCtx.font=(b.y1-b.y0-2)+"px Arial"; offCtx.fillText(fakeData.phone,b.x0,b.y1-2);
          }
          if(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)){
            offCtx.fillStyle="#fff"; offCtx.fillRect(b.x0-1,b.y0-1,b.x1-b.x0+2,b.y1-b.y0+2);
            offCtx.fillStyle="#000"; offCtx.font=(b.y1-b.y0-2)+"px Arial"; offCtx.fillText(fakeData.email,b.x0,b.y1-2);
          }
        }
      });
    });

    // Draw final processed image to visible canvas
    canvas.width = offCanvas.width;
    canvas.height = offCanvas.height;
    ctx.drawImage(offCanvas,0,0);

    showToast('Redaction & face blur completed');

  } catch(err){
    console.error(err);
    showToast('Error during processing','error');
  } finally{
    processingIndicator.classList.remove('active');
  }
}

// Save processed file
saveBtn.addEventListener('click', ()=>{
  if(!uploadedImage){ showToast("No processed document to save","error"); return; }
  const dataUrl = canvas.toDataURL();
  const currentUser = localStorage.user || "guest";
  const allUsers = JSON.parse(localStorage.getItem("users_files")||"{}");
  if(!allUsers[currentUser]) allUsers[currentUser]=[];
  allUsers[currentUser].push({name:currentFileName, data:dataUrl});
  localStorage.setItem("users_files", JSON.stringify(allUsers));
  localStorage.setItem("redactedFile", dataUrl);
  showToast("File saved successfully for your dashboard");
});

// Logout
logoutBtn.addEventListener('click', ()=>{
  localStorage.removeItem('user');
  uploadedImage=null;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  showToast("Logged out successfully","success");
  setTimeout(() => { window.location.href = "login.html"; }, 500);
});
</script>
</body>
</html>